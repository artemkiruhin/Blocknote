@page "/edit/{id:guid}"
@using Blocknote.Core.Models.Dtos
@using Blocknote.Core.Models.Enums
@using Blocknote.Core.Services.Base
@using Blocknote.Core.Services.Entity
@using Blocknote.Core.Services.Jwt
@using Blocknote.Core.Services.Sharing
@using System.Text
@using Microsoft.AspNetCore.Builder
@using Microsoft.JSInterop
@using System.Diagnostics
@using iTextSharp.text
@using iTextSharp.text.pdf
@using DocumentFormat.OpenXml.Packaging
@using DocumentFormat.OpenXml.Wordprocessing

@inject INoteService NoteService
@inject IJwtService JwtService
@inject NavigationManager NavigationManager
@inject ISharingService SharingService

<div class="modal">
    <div class="modal-content">
        <h2>@(Id.HasValue ? "Редактировать заметку" : "Создать новую заметку")</h2>
        @if (!string.IsNullOrEmpty(ErrorMessage))
        {
            <div class="error-message">@ErrorMessage</div>
        }
        <EditForm Model="@CurrentNote" OnValidSubmit="OnSave">
            <DataAnnotationsValidator />
            <div>
                <input type="text" class="modal-input" placeholder="Заголовок заметки" @bind-value="LocalTitle" @bind-value:event="oninput" />
                <ValidationMessage For="@(() => LocalTitle)" />
            </div>
            <div>
                <input type="text" class="modal-input" placeholder="Подзаголовок (необязательно)" @bind-value="LocalSubtitle" @bind-value:event="oninput" />
            </div>
            <div>
                <textarea class="modal-textarea" placeholder="Содержание заметки (необязательно)" @bind-value="LocalContent" @bind-value:event="oninput"></textarea>
            </div>
            <div class="modal-buttons">
                <button type="button" class="modal-cancel" @onclick="OnClose">Отмена</button>
                <button type="submit" class="modal-save" disabled="@(!IsFormValid)">
                    @(Id.HasValue ? "Обновить" : "Сохранить")
                </button>
                @if (Id.HasValue)
                {
                    <button type="button" class="modal-share" @onclick="OnShare">Поделиться</button>
                    <button type="button" class="modal-delete" @onclick="ShowDeleteConfirmation">Удалить</button>
                    <button type="button" class="modal-export" @onclick="ExportToMarkdown">Экспорт в Markdown</button>
                    <button type="button" class="modal-export" @onclick="ExportToWord">Экспорт в Word</button>
                    <button type="button" class="modal-export" @onclick="ExportToPdf">Экспорт в PDF</button>
                }
            </div>
        </EditForm>
    </div>
</div>

@code {
    [Parameter] public Guid? Id { get; set; }

    private NoteDto CurrentNote { get; set; } = new NoteDto();
    private string LocalTitle { get; set; } = string.Empty;
    private string LocalSubtitle { get; set; } = string.Empty;
    private string LocalContent { get; set; } = string.Empty;
    private string? ErrorMessage { get; set; }
    private bool ShowDeleteConfirmationModal { get; set; } = false;

    private bool IsFormValid =>
        !string.IsNullOrWhiteSpace(LocalTitle);

    protected override async Task OnInitializedAsync()
    {
        if (Id.HasValue)
        {
            await LoadNote();
        }
    }

    private async Task LoadNote()
    {
        try
        {
            var token = await SecureStorage.Default.GetAsync("jwt");
            if (string.IsNullOrEmpty(token))
            {
                NavigationManager.NavigateTo("auth");
                return;
            }

            var userId = JwtService.GetUserId(token);
            if (userId == Guid.Empty)
            {
                ErrorMessage = "Ошибка авторизации.";
                return;
            }

            CurrentNote = await NoteService.GetInfoAsync(userId, Id.Value);
            if (CurrentNote != null)
            {
                LocalTitle = CurrentNote.Title;
                LocalSubtitle = CurrentNote.Subtitle;
                LocalContent = CurrentNote.Content;
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Не удалось загрузить заметку: {ex.Message}";
        }
    }

    private void OnShare()
    {
        if (Id.HasValue)
        {
            var noteId = Id.Value.ToString("D"); // Ensures proper Guid format
            NavigationManager.NavigateTo($"/sharing/create/{noteId}");
        }
    }

    private async Task OnSave()
    {
        try
        {
            var token = await SecureStorage.Default.GetAsync("jwt");
            if (string.IsNullOrEmpty(token))
            {
                NavigationManager.NavigateTo("auth");
                return;
            }

            var userId = JwtService.GetUserId(token);
            if (userId == Guid.Empty)
            {
                ErrorMessage = "Ошибка авторизации.";
                return;
            }

            bool result;
            if (Id.HasValue)
            {
                result = await NoteService.EditAsync(userId, Id.Value, LocalTitle, LocalSubtitle, LocalContent);
            }
            else
            {
                result = await NoteService.CreateAsync(LocalTitle, LocalSubtitle, LocalContent, userId);
            }

            if (result)
            {
                NavigationManager.NavigateTo("/");
            }
            else
            {
                ErrorMessage = "Не удалось сохранить изменения.";
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Произошла ошибка: {ex.Message}";
        }
    }

    private void ShowDeleteConfirmation() => ShowDeleteConfirmationModal = true;

    private void CancelDelete() => ShowDeleteConfirmationModal = false;

    private async Task OnDelete()
    {
        if (!Id.HasValue) return;

        try
        {
            var token = await SecureStorage.Default.GetAsync("jwt");
            if (string.IsNullOrEmpty(token))
            {
                NavigationManager.NavigateTo("auth");
                return;
            }

            var userId = JwtService.GetUserId(token);
            if (userId == Guid.Empty)
            {
                ErrorMessage = "Ошибка авторизации.";
                return;
            }

            bool result = await NoteService.DeleteAsync(userId, Id.Value);

            if (result)
            {
                NavigationManager.NavigateTo("/");
            }
            else
            {
                ErrorMessage = "Не удалось удалить заметку.";
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Произошла ошибка: {ex.Message}";
        }
    }

    private void OnClose()
    {
        NavigationManager.NavigateTo("/");
    }

    private async Task ExportToMarkdown()
    {
        var markdown = $"# {LocalTitle}\n\n{(string.IsNullOrEmpty(LocalSubtitle) ? "" : $"## {LocalSubtitle}\n\n")}{LocalContent}";
        await SaveFile(markdown, LocalTitle, "md");
    }

    private async Task ExportToWord()
    {
        try
        {
            var documentsPath = Environment.GetFolderPath(Environment.SpecialFolder.MyDocuments);
            var exportPath = Path.Combine(documentsPath, "Blocknote", "Exports");
            Directory.CreateDirectory(exportPath);

            var filePath = Path.Combine(exportPath, $"{LocalTitle}.docx");

            using (WordprocessingDocument wordDocument = WordprocessingDocument.Create(filePath, DocumentFormat.OpenXml.WordprocessingDocumentType.Document))
            {
                MainDocumentPart mainPart = wordDocument.AddMainDocumentPart();
                mainPart.Document = new DocumentFormat.OpenXml.Wordprocessing.Document();
                Body body = new Body();

                body.AppendChild(new DocumentFormat.OpenXml.Wordprocessing.Paragraph(new Run(new Text(LocalTitle))) { ParagraphProperties = new ParagraphProperties(new Justification { Val = JustificationValues.Center }) });
                if (!string.IsNullOrEmpty(LocalSubtitle))
                {
                    body.AppendChild(new DocumentFormat.OpenXml.Wordprocessing.Paragraph(new Run(new Text(LocalSubtitle))) { ParagraphProperties = new ParagraphProperties(new Justification { Val = JustificationValues.Center }) });
                }
                body.AppendChild(new DocumentFormat.OpenXml.Wordprocessing.Paragraph(new Run(new Text(LocalContent))));

                mainPart.Document.AppendChild(body);
                mainPart.Document.Save();
            }

            await Application.Current.MainPage.DisplayAlert("Успешно", $"Файл сохранён в {filePath}", "OK");
            Process.Start(new ProcessStartInfo { FileName = exportPath, UseShellExecute = true });
        }
        catch (Exception ex)
        {
            await Application.Current.MainPage.DisplayAlert("Ошибка", ex.Message, "OK");
        }
    }

    private async Task ExportToPdf()
    {
        try
        {
            var documentsPath = Environment.GetFolderPath(Environment.SpecialFolder.MyDocuments);
            var exportPath = Path.Combine(documentsPath, "Blocknote", "Exports");
            Directory.CreateDirectory(exportPath);

            var filePath = Path.Combine(exportPath, $"{LocalTitle}.pdf");

            using (FileStream fs = new FileStream(filePath, FileMode.Create))
            {
                iTextSharp.text.Document document = new iTextSharp.text.Document();
                PdfWriter.GetInstance(document, fs);
                document.Open();

                var font = FontFactory.GetFont(FontFactory.HELVETICA, 12, BaseColor.BLACK);
                document.Add(new iTextSharp.text.Paragraph(LocalTitle, font));
                if (!string.IsNullOrEmpty(LocalSubtitle)) document.Add(new iTextSharp.text.Paragraph(LocalSubtitle, font));
                if (!string.IsNullOrEmpty(LocalContent)) document.Add(new iTextSharp.text.Paragraph(LocalContent, font));

                document.Close();
            }

            await Application.Current.MainPage.DisplayAlert("Успешно", $"Файл сохранён в {filePath}", "OK");

            Process.Start(new ProcessStartInfo { FileName = exportPath, UseShellExecute = true });
        }
        catch (Exception ex)
        {
            await Application.Current.MainPage.DisplayAlert("Ошибка", ex.Message, "OK");
        }
    }

    public string FormatToPDF(string content, string filePath)
    {
        try
        {
            return filePath;
        }
        catch (Exception ex)
        {
            throw new Exception("Ошибка при создании PDF: " + ex.Message);
        }
    }

    private async Task SaveFile(string content, string fileName, string fileExtension)
    {
        try
        {
            var documentsPath = Environment.GetFolderPath(Environment.SpecialFolder.MyDocuments);
            var exportPath = Path.Combine(documentsPath, "Blocknote", "Exports");
            Directory.CreateDirectory(exportPath);

            var filePath = Path.Combine(exportPath, $"{fileName}.{fileExtension}");
            await File.WriteAllTextAsync(filePath, content);
            await Application.Current.MainPage.DisplayAlert("Успешно", $"Файл сохранён в {filePath}", "OK");

            Process.Start(new ProcessStartInfo { FileName = exportPath, UseShellExecute = true });
        }
        catch (Exception ex)
        {
            await Application.Current.MainPage.DisplayAlert("Ошибка", ex.Message, "OK");
        }
    }

}
